var OpenX={enabled:false,sessid:"",url:"//trex.plurk.com/d/",banners:{},btime:{},campaigns:{},kwads:[],kwtime:0,kwnum:0,country_code:"",afc_zone:false,test:true,adsense_enabled:true,init:function(a){this.enabled=true;this.sessid=Math.floor(Math.random()*10000000).toString(36);this.country_code=a;if(a=="TW"){try{jQuery.getJSON("/Ads/getAds?zone=41",function(e){OpenX.kwads=e;for(var c in OpenX.kwads){var d=OpenX.kwads[c];d.impr=0;if(!OpenX.campaigns[d.c]){OpenX.campaigns[d.c]={impr:0,count:0}}d.a=new RegExp(d.a,"i")}OpenX.kwnum=OpenX.kwads.length;OpenX.kwtime=(new Date()).getTime()/1000})}catch(b){}}},getLinks:function(d,c){rnd=Math.floor(Math.random()*10000000);lparam=["bannerid="+c.id,"campaignid="+c.c,"zoneid="+d,"OACBLOCK="+c.t,"OASCCAP=1","loc="+encodeURIComponent(window.location),"cb="+rnd];cparam=["bannerid="+c.id,"zoneid="+d,"cb="+rnd,"oadest="+encodeURIComponent(c.u)];var a={id:c.id,imgUrl:(c.b&&c.b.indexOf("http")==-1)?"https://banana.plurk.com/"+c.b:c.b,url:c.u,plurk:c.e,logUrl:this.url+"lg.php?uh="+this.sessid+"&"+lparam.join("&"),clickUrl:this.url+"a.php?uh="+this.sessid+"&oaparams=2__"+cparam.join("__"),probability:c.p};return a},logImpr:function(b){var a=new Image();a.onload=function(c){return};a.src=b},showAds:function(b,a){var c=this.getLinks(b,a);if(c.imgUrl.indexOf(".swf",c.imgUrl.length-4)!=-1){document.write('<embed type="application/x-shockwave-flash" src="'+c.imgUrl+'" width="'+a.w+'" height="'+a.h+'" quality="high" allowscriptaccess="always" flashvars="clickTARGET=_blank&amp;clickTAG='+escape(c.clickUrl)+'">');OpenX.logImpr(c.logUrl)}else{document.write('<a href="'+c.clickUrl+'" target="_blank"><img src="'+c.imgUrl+'" onload="OpenX.logImpr(\''+c.logUrl+"')\"></a>")}},showAll:function(){jQuery(".openx").each(function(c){var b=jQuery(this).data("zone");var a=jQuery(this).data("banner");var d=OpenX.getLinks(b,a);if(d.imgUrl.indexOf(".swf",d.imgUrl.length-4)!=-1){jQuery(this).html('<embed type="application/x-shockwave-flash" src="'+d.imgUrl+'" width="'+a.w+'" height="'+a.h+'" quality="high" allowscriptaccess="always" flashvars="clickTARGET=_blank&amp;clickTAG='+escape(d.clickUrl)+'">');OpenX.logImpr(d.logUrl)}else{jQuery(this).html('<a href="'+d.clickUrl+'" target="_blank"><img src="'+d.imgUrl+'" onload="OpenX.logImpr(\''+d.logUrl+"')\"></a>")}})},getAllAds:function(c,d){if(!c||!d){return}if(!this.enabled){return d(null)}var b=(new Date()).getTime()/1000;if(!(c in this.banners)||!(c in this.btime)||b>this.btime[c]+300||Math.floor(b/86400)!=Math.floor(this.btime[c]/86400)){try{jQuery.getJSON("/Ads/getAds?zone="+c,function(p){OpenX.banners[c]=p;OpenX.btime[c]=b;var n=[];for(var i in OpenX.banners[c]){var j=OpenX.banners[c][i];var k=(j.e)?j.e.match(/.+\/user\/([\w\d_]+)#(\d+)/):false;if(k){var l=k[1];var h=(k[2])?parseInt(k[2]):1}else{var e=(j.e)?j.e.match(/.+\/p\/(\w+)/):"";if(e){j.e=parseInt(e[1],36)}n.push(OpenX.getLinks(c,j))}}d(n)})}catch(f){}return}var g=[];for(var a in OpenX.banners[c]){g.push(OpenX.getLinks(c,OpenX.banners[c][a]))}d(g)},getAds:function(j,b,h,f){if(!j||!b){return}if(!this.enabled){return b(null)}if(typeof h=="undefined"){h=true}var c=(new Date()).getTime()/1000;if(j==33&&f){if(this.kwnum>0){var a=Plurk.getById(f);if(a){var i=this.kwads.length;for(var l in this.kwads){var k=this.kwads[l];var d=this.campaigns[k.c];if(h&&k.t&&k.n&&d&&(c-d.impr)<k.t&&d.count>=k.n){i--;continue}if(k.a&&k.a.test(a.content)){k.impr=Math.floor(c);if(h){if(d){if((c-d.impr)>=k.t){d.count=1}else{d.count++}d.impr=k.impr}else{this.campaigns[k.c]={impr:k.impr,count:1}}}b(this.getLinks(41,k));return}}this.kwnum=i}}if(this.kwtime>0&&(c-this.kwtime)>1800){try{jQuery.getJSON("/Ads/getAds?zone=41",function(n){OpenX.kwads=n;for(var e in OpenX.kwads){var m=OpenX.kwads[e];m.impr=0;if(!OpenX.campaigns[m.c]){OpenX.campaigns[m.c]={impr:0,count:0}}m.a=new RegExp(m.a,"i")}OpenX.kwnum=OpenX.kwads.length;OpenX.kwtime=(new Date()).getTime()/1000})}catch(g){}}}if(!(j in this.banners)||!(j in this.btime)||c>this.btime[j]+300||Math.floor(c/86400)!=Math.floor(this.btime[j]/86400)){try{jQuery.getJSON("/Ads/getAds?zone="+j,function(m){OpenX.banners[j]=m;OpenX.btime[j]=c;for(var e in OpenX.banners[j]){k=OpenX.banners[j][e];if(!OpenX.campaigns[k.c]){OpenX.campaigns[k.c]={impr:0,count:0}}k.impr=0}b(OpenX.getRandomBanner(j))}).fail(function(n,m,o){if(m==="error"){b({adsjsonerror:"error"})}})}catch(g){}return}b(this.getRandomBanner(j,h))},getRandomBanner:function(i,h){if(typeof h=="undefined"){h=true}if(!this.banners[i]||this.banners[i].length==0){return{}}var k,j,e;var c=(new Date()).getTime()/1000;var d=0;for(k in this.banners[i]){j=this.banners[i][k];e=this.campaigns[j.c];if(!(h&&j.t&&j.n&&e&&(c-e.impr)<j.t&&e.count>=j.n)){d+=j.p}}if(d<8000){d*=1.25}var a=Math.floor(Math.random()*d);d=0;var f=[];var g=[];for(k in this.banners[i]){j=this.banners[i][k];e=this.campaigns[j.c];if(h&&j.t&&j.n&&e&&(c-e.impr)<j.t&&e.count>=j.n){continue}if(j.p<25){continue}d+=j.p;if(a<d){j.impr=Math.floor(c);if(h){if(e){if((c-e.impr)>=j.t){e.count=1}else{e.count++}e.impr=j.impr}else{this.campaigns[j.c]={impr:j.impr,count:1}}}var b=j.e.match(/.+\/p\/(\w+)/);if(b){j.e=parseInt(b[1],36)}return this.getLinks(i,j)}}return{}},insertYahoo:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/respondo_yahoo_cpm_300x50.html" width="468" height="50" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},insertClickforce:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/respondo_clickforce_468x60.html" width="468" height="60" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},insertSkimlinks:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/skimlinks_respondo_468x60.html" width="468" height="60" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},insertChitika:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/chitika_respondo_468x60.html" width="468" height="60" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},insertClicksor:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/clicksor_468x60.html" width="468" height="60" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},insertAdversal:function(b){var a='<iframe allowtransparency="true" src="//banana.plurk.com/adversal_468x60.html" width="468" height="60" framespacing="0" frameborder="no" scrolling="no"></iframe>';b.html(a)},getEmbeddedPlurk:function(){this.getAllAds(37,function(b){if(OpenX.country_code!="TW"){return}for(var a in b){alert("pid: "+b[a].plurk+" (p: "+b[a].probability+")")}})},insertAds:function(d,b,c){if(SiteState.getSessionUser()&&!SiteState.getSessionUser().show_ads){return}var a=(OpenX.country_code=="TW")?33:45;this.getAds(a,function(g){if(typeof(g)==="object"&&g&&g.adsjsonerror==="error"){var j=jQuery(d).data("abcb");if(typeof(j)==="function"){j()}return}if(c){OpenX.insertClickforce(d);return}if(!g||!g.imgUrl){if(!OpenX.adsense_enabled){if(OpenX.country_code=="TW"){OpenX.insertClickforce(d)}else{OpenX.insertSkimlinks(d)}return}if(!OpenX.afc_zone||!OpenX.afc_zone[a]){if(OpenX.country_code=="TW"&&Math.random()<0.02){OpenX.insertClickforce(d);return}try{jQuery.getJSON("/Ads/getAFC",function(k){OpenX.afc_zone=k;if(OpenX.afc_zone&&OpenX.afc_zone[a]){var e=OpenX.afc_zone[a];OpenX.insertAFC(d,b,e.slot,e.width,e.height)}})}catch(h){return}}else{if(OpenX.country_code=="TW"&&Math.random()<0.02){OpenX.insertClickforce(d);return}var i=OpenX.afc_zone[a];OpenX.insertAFC(d,b,i.slot,i.width,i.height)}return}var f=jQuery("<img class='openx_img'>").each(function(){if(this.complete){jQuery(this).trigger("load")}}).one("load",function(){if(this.height==1){return}OpenX.logImpr(g.logUrl);d.html(f)}).click(function(){window.open(g.clickUrl);return false}).attr("src",g.imgUrl)},true,b)},insertAFC:function(f,b,j,a,k){if(!b){return}google_ad_client="ca-pub-2279165183083294";google_ad_slot=j;google_ad_width=a;google_ad_height=k;google_page_url="http://www.plurk.com/m/p/"+b.toString(36);var c="google_";var i=window[c+"persistent_state_async"];if(i&&i.S){i.S[c+"num_ad_slots"]=0;i.S[c+"prev_ad_slotnames_by_region"]=""}var h="";document.write=function(e){h+=e};try{jQuery.getScript("https://pagead2.googlesyndication.com/pagead/show_ads.js",function(){jQuery(f).html(h)})}catch(d){}}};